rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return isSignedIn()
        && request.auth.token.email == 'whiteh4tter@gmail.com'
        && request.auth.token.email_verified == true;
    }

    function currentUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function currentUserOrgId() {
      return currentUserDoc().data.organizationId;
    }

    function orgAdminOrgId() {
      return currentUserDoc().data.adminOrganizationId;
    }

    function isOrgAdmin() {
      return isSignedIn()
        && currentUserDoc().exists()
        && orgAdminOrgId() is string;
    }

    function sameOrganizationAsCurrentUser() {
      return isSignedIn()
        && currentUserDoc().exists()
        && currentUserOrgId() is string
        && resource.data.organizationId == currentUserOrgId();
    }

    function validNewUserProfile(userId) {
      return request.resource.data.keys().hasOnly([
        'name',
        'email',
        'photoURL',
        'organizationId',
        'organizationName',
        'adminOrganizationId',
        'xp',
        'level',
        'createdAt',
        'lastActive',
      ])
      && request.resource.data.name is string
      && (request.resource.data.email == null || request.resource.data.email is string)
      && (request.resource.data.photoURL == null || request.resource.data.photoURL is string)
      && request.resource.data.organizationId == null
      && request.resource.data.organizationName == null
      && request.resource.data.adminOrganizationId == null
      && request.resource.data.xp is number
      && request.resource.data.level is number
      && request.resource.data.xp >= 0
      && request.resource.data.level >= 1
      && request.resource.data.createdAt is timestamp
      && request.resource.data.lastActive is timestamp
      && isOwner(userId);
    }

    function validOwnerScoreUpdate() {
      let xpDelta = request.resource.data.xp - resource.data.xp;
      return xpDelta >= 0
        && xpDelta <= 20
        && request.resource.data.level is number
        && request.resource.data.level >= resource.data.level
        && request.resource.data.level <= resource.data.level + 1;
    }

    function validOwnerOrgSet() {
      return resource.data.organizationId == null
        && resource.data.organizationName == null
        && request.resource.data.organizationId is string
        && request.resource.data.organizationName is string;
    }

    function ownerWriteRateLimited() {
      return resource.data.lastActive is timestamp
        && request.resource.data.lastActive is timestamp
        && request.time >= resource.data.lastActive + duration.value(1, 's');
    }

    function validOwnerUpdate(userId) {
      let changed = request.resource.data.diff(resource.data).changedKeys();
      let scoreChanged = changed.hasAny(['xp', 'level']);
      let orgChanged = changed.hasAny(['organizationId', 'organizationName']);

      return isOwner(userId)
        && changed.hasOnly(['xp', 'level', 'lastActive', 'organizationId', 'organizationName'])
        && request.resource.data.name == resource.data.name
        && request.resource.data.email == resource.data.email
        && request.resource.data.photoURL == resource.data.photoURL
        && request.resource.data.adminOrganizationId == resource.data.adminOrganizationId
        && request.resource.data.createdAt == resource.data.createdAt
        && ownerWriteRateLimited()
        && (!scoreChanged || validOwnerScoreUpdate())
        && (!orgChanged || validOwnerOrgSet());
    }

    function validOrgAdminManagedUserUpdate(userId) {
      let changed = request.resource.data.diff(resource.data).changedKeys();

      return isOrgAdmin()
        && !isOwner(userId)
        && resource.data.organizationId == orgAdminOrgId()
        && request.resource.data.organizationId == orgAdminOrgId()
        && request.resource.data.organizationName is string
        && request.resource.data.adminOrganizationId == resource.data.adminOrganizationId
        && changed.hasOnly(['organizationId', 'organizationName', 'lastActive'])
        && request.resource.data.name == resource.data.name
        && request.resource.data.email == resource.data.email
        && request.resource.data.photoURL == resource.data.photoURL
        && request.resource.data.xp == resource.data.xp
        && request.resource.data.level == resource.data.level
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.lastActive is timestamp;
    }

    function validOrgAdminOrganizationUpdate(organizationId) {
      let changed = request.resource.data.diff(resource.data).changedKeys();

      return isOrgAdmin()
        && organizationId == orgAdminOrgId()
        && changed.hasOnly(['name', 'description'])
        && request.resource.data.keys().hasOnly(['name', 'description', 'createdAt'])
        && request.resource.data.name is string
        && request.resource.data.description is string
        && request.resource.data.createdAt == resource.data.createdAt;
    }

    function validOrgAdminDeleteUser(userId) {
      return isOrgAdmin()
        && !isOwner(userId)
        && resource.data.organizationId == orgAdminOrgId();
    }

    match /users/{userId} {
      allow get: if isSuperAdmin() || isOwner(userId) || sameOrganizationAsCurrentUser();
      allow list: if isSuperAdmin() || sameOrganizationAsCurrentUser();
      allow create: if validNewUserProfile(userId);
      allow update: if isSuperAdmin()
        || validOwnerUpdate(userId)
        || validOrgAdminManagedUserUpdate(userId);
      allow delete: if isSuperAdmin() || validOrgAdminDeleteUser(userId);
    }

    match /organizations/{organizationId} {
      allow get, list: if isSignedIn();
      allow create, delete: if isSuperAdmin();
      allow update: if isSuperAdmin() || validOrgAdminOrganizationUpdate(organizationId);
    }
  }
}
